# バッチ処理機能 使い方ガイド

## 📦 概要

バッチ処理機能は、複数のSNS投稿を一括で生成・処理するための機能です。Google Sheetsの下書きシートから未完成の投稿を読み込み、Claude AIで自動生成し、結果をシートに保存またはCSVでエクスポートできます。

## 🎯 こんな時に便利

- **月間投稿の一括生成**: 1ヶ月分の投稿を一気に作成
- **定期投稿の自動化**: 毎週・毎日の定期投稿を効率化
- **大量の製品PR**: 複数商品のPR投稿をまとめて処理
- **時間短縮**: 手動で1件ずつ作成する手間を削減

## 🚀 使い方

### ステップ1: Google Sheetsの準備

#### 1.1 下書きシートのフォーマット

バッチ処理は `SNS投稿_下書き` シート（またはカスタムシート名）からデータを読み込みます。

**必須カラム:**
- `投稿日`: 投稿予定日（例: 2025-01-15）
- `URL`: 商品URLまたは関連URL
- `決定事項`: 投稿の方針や訴求内容
- `記念日`: （オプション）関連する記念日
- `補足`: （オプション）追加情報

**例:**

| 作成日時 | 投稿日 | URL | 決定事項 | 記念日 | 補足 | 最終投稿 |
|---------|--------|-----|----------|--------|------|----------|
| | 2025-01-15 | https://ec.midori-anzen.com/... | 防災の日にヘルメットPR | 防災の日 | 子供向け | |
| | 2025-01-20 | https://ec.midori-anzen.com/... | 作業手袋の新商品紹介 | | 耐切創性能強調 | |

#### 1.2 未完成投稿の条件

バッチ処理では以下の条件を満たす行のみ処理されます：

- ✅ `決定事項` が入力されている
- ✅ `最終投稿` が空（未完成）
- ❌ すでに `最終投稿` がある行はスキップ

### ステップ2: バッチ処理画面へアクセス

```
http://127.0.0.1:5000/batch
```

ブラウザで上記URLにアクセスします。

### ステップ3: 処理設定

#### 3.1 データソースの選択

**Google Sheets（推奨）**
- シート名: `SNS投稿_下書き`（デフォルト）
- 開始行: `2`（ヘッダー行の次）
- 終了行: `0`（全件）または特定の行番号

**例: 2行目〜10行目のみ処理**
```
開始行: 2
終了行: 10
```

**例: すべての未完成投稿を処理**
```
開始行: 2
終了行: 0
```

#### 3.2 処理オプション

| オプション | 説明 | 推奨設定 |
|-----------|------|----------|
| **自動保存** | 生成した投稿を自動でSheetsに保存 | ✅ ON |
| **エラーをスキップ** | エラー時に次の投稿へ進む | ✅ ON |
| **投稿間に待機時間** | API制限対策で3秒待機 | ✅ ON |

### ステップ4: データ読み込み

「データを読み込む 📂」ボタンをクリックします。

**読み込まれる内容:**
- 未完成投稿の一覧
- 各投稿の詳細情報
- 処理対象件数

**確認項目:**
- 読み込み件数が正しいか
- 投稿日・決定事項が正確か
- 不要な行が含まれていないか

### ステップ5: バッチ処理開始

「バッチ処理を開始 🚀」ボタンをクリックします。

**処理の流れ:**

```
[投稿1] → コンテキスト取得 → Claude AI生成 → 保存 → 完了
   ↓（3秒待機）
[投稿2] → コンテキスト取得 → Claude AI生成 → 保存 → 完了
   ↓（3秒待機）
[投稿3] → ...
```

**各投稿の処理時間:** 約30〜60秒
**10件の場合の合計時間:** 約5〜10分

#### リアルタイム進捗表示

処理中は以下が表示されます：

- **進捗バー**: 全体の処理進捗
- **現在処理中の投稿情報**: 投稿日、決定事項
- **ステータス一覧**:
  - ⏳ 処理中
  - ✅ 成功
  - ❌ エラー

### ステップ6: 結果確認

処理完了後、結果サマリーが表示されます：

```
📊 結果サマリー
━━━━━━━━━━━━━━━━━━━━
合計:   10件
成功:    9件
エラー:  1件
```

**結果テーブル:**

| No. | 投稿日 | ステータス | 生成された投稿 |
|-----|--------|-----------|---------------|
| 1 | 2025-01-15 | ✅ 成功 | 製造現場の安全管理、悩んでいませんか？... |
| 2 | 2025-01-20 | ✅ 成功 | 作業手袋の新商品をご紹介✨... |
| 3 | 2025-01-25 | ❌ エラー | API rate limit exceeded |

### ステップ7: 結果のエクスポート

「結果をエクスポート 📥」ボタンをクリックすると、CSVファイルがダウンロードされます。

**ファイル名:** `batch_results_20250123_143022.csv`

**CSVフォーマット:**
```csv
行番号,投稿日,ステータス,生成された投稿,エラー
2,2025-01-15,success,"製造現場の安全管理、悩んでいませんか？...",
3,2025-01-20,success,"作業手袋の新商品をご紹介✨...",
4,2025-01-25,error,,API rate limit exceeded
```

## 📋 保存される場所

### 自動保存ON の場合

#### 1. 下書きシート（更新）
元の行が更新されます：
- `最終投稿`: 生成された投稿テキスト
- `文字数`: 投稿の文字数
- `文字数チェック`: ✅ または ❌
- `ラウンド数`: 1（初回生成）
- `Pinecone結果数`: 取得した商品情報数
- `類似投稿数`: 過去の類似投稿数

#### 2. 完成シート（追加）
`SNS投稿_完成版` シートに新しい行として追加されます。

### 自動保存OFF の場合

Google Sheetsには保存されず、画面上とCSVエクスポートでのみ確認できます。

## ⚙️ 処理の詳細

### コンテキスト取得

各投稿について、以下の情報が自動取得されます：

1. **Pinecone検索**
   - `決定事項` から関連商品を検索
   - 最大5件の商品情報
   - 商品特徴・仕様・価格など

2. **類似投稿検索**
   - 過去の投稿から似た内容を検索
   - 最大3件の類似投稿
   - セマンティック検索（意味的な類似度）

### 投稿生成

Claude 4.5 Sonnet が以下を実行：

1. コンテキスト情報の分析
2. 2つの投稿案（A/B）の生成
3. 自動的に案Aを選択（バッチ処理時）
4. 文字数チェック（全角140字以内）

### エラー処理

**「エラーをスキップ」ON の場合:**
- エラーが発生しても次の投稿へ進む
- エラー内容は記録される

**「エラーをスキップ」OFF の場合:**
- エラー発生時点で処理を中断
- それまでの結果は保存される

## 🔧 トラブルシューティング

### Q1: 「処理対象の投稿が見つかりませんでした」と表示される

**原因:**
- 下書きシートに未完成投稿がない
- `決定事項` が空
- 指定した行範囲に該当データがない

**解決策:**
1. 下書きシートを確認
2. `決定事項` カラムに内容を入力
3. `最終投稿` カラムが空であることを確認

### Q2: エラーが多発する

**原因:**
- API rate limit（Claude API制限）
- ネットワークエラー
- Google Sheets権限不足

**解決策:**
1. 「投稿間に待機時間」をONにする
2. 処理件数を減らす（5〜10件ずつ）
3. Google Sheetsの共有設定を確認

### Q3: 生成された投稿が保存されない

**原因:**
- 「自動保存」がOFF
- Google Sheets権限エラー
- シートのヘッダーが正しくない

**解決策:**
1. 「自動保存」をONにする
2. サービスアカウントの共有設定を確認
3. 下書きシートのヘッダー行を確認

### Q4: 処理が途中で止まる

**原因:**
- ネットワーク切断
- ブラウザのタブを閉じた
- APIエラー

**解決策:**
1. 結果テーブルで最後に成功した行を確認
2. 開始行を次の行に設定して再実行
3. エラーログを確認

## 💡 ベストプラクティス

### 1. 少量でテスト

初めて使用する場合：
```
開始行: 2
終了行: 5  # 3件だけテスト
```

### 2. 段階的に処理

大量の投稿がある場合：
```
1回目: 2〜11行（10件）
2回目: 12〜21行（10件）
3回目: 22〜31行（10件）
```

### 3. オプション設定の推奨

| 処理件数 | 自動保存 | エラースキップ | 待機時間 |
|---------|---------|--------------|----------|
| 〜5件 | ON | OFF | OFF |
| 6〜20件 | ON | ON | ON |
| 21件〜 | ON | ON | ON |

### 4. 事前準備

バッチ処理前に確認：
- [ ] Google Sheetsの権限
- [ ] Claude API quota残量
- [ ] 投稿データの正確性
- [ ] ネットワーク接続

### 5. エラーログの確認

エラーが発生した場合、ブラウザのコンソールを確認：
```
Chrome: F12 → Console タブ
```

## 📈 処理速度の目安

| 件数 | 待機時間ON | 待機時間OFF |
|-----|-----------|------------|
| 5件 | 約3〜5分 | 約2〜3分 |
| 10件 | 約6〜10分 | 約4〜6分 |
| 20件 | 約12〜20分 | 約8〜12分 |
| 50件 | 約30〜50分 | 約20〜30分 |

**注意:**
- Claude APIの応答時間により変動します
- 待機時間OFFの場合、API制限に注意

## 🎓 応用例

### 例1: 月間投稿計画の一括生成

```
シナリオ: 2月分の投稿（28件）を週末に一括生成

設定:
- 開始行: 2
- 終了行: 30
- 自動保存: ON
- エラースキップ: ON
- 待機時間: ON

実行時間: 約50分
結果: 28件中26件成功、2件エラー
→ エラー分のみ手動で再実行
```

### 例2: 商品カテゴリ別の投稿生成

```
シナリオ: ヘルメット製品（10件）→ 手袋製品（15件）

1回目:
- 開始行: 2  # ヘルメット開始
- 終了行: 11 # ヘルメット終了
→ 結果をエクスポート

2回目:
- 開始行: 12 # 手袋開始
- 終了行: 26 # 手袋終了
→ 結果をエクスポート
```

### 例3: 毎週の定期投稿

```
シナリオ: 毎週月曜に次の1週間分（7件）を生成

月曜朝:
- 開始行: 次週の月曜日の行
- 終了行: 次週の日曜日の行
- 自動保存: ON

所要時間: 約5〜8分
→ 週の投稿準備完了
```

## 🔒 セキュリティとプライバシー

- API通信は全てHTTPS
- Google Sheets認証はOAuth 2.0またはサービスアカウント
- 生成された投稿は指定されたシートにのみ保存
- CSVエクスポートはローカルダウンロードのみ

## 📞 サポート

問題が解決しない場合：

1. **ログの確認**: ブラウザコンソールとFlaskログ
2. **環境変数の確認**: `.env` ファイルの設定
3. **GitHubイシュー**: https://github.com/your-repo/issues

---

**バージョン**: 1.0.0
**最終更新**: 2025-01-23
