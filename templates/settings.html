{% extends "base.html" %}

{% block title %}プロンプト設定 - PostCrafterPro{% endblock %}

{% block content %}
<div x-data="promptSettings()" x-cloak class="max-w-5xl mx-auto">

    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">⚙️ プロンプト設定</h1>
        <p class="text-gray-600">システムプロンプトとユーザープロンプトをカスタマイズできます</p>
    </div>

    <!-- Success/Error Messages -->
    <div x-show="successMessage" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        <span x-text="successMessage"></span>
    </div>

    <div x-show="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <span x-text="errorMessage"></span>
    </div>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button @click="currentTab = 'initial'"
                    class="pb-4 px-1 border-b-2 font-medium text-sm transition"
                    :class="currentTab === 'initial' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
                🚀 初回生成
            </button>
            <button @click="currentTab = 'refinement'"
                    class="pb-4 px-1 border-b-2 font-medium text-sm transition"
                    :class="currentTab === 'refinement' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
                ✨ 改善
            </button>
        </nav>
    </div>

    <!-- Initial Generation Tab -->
    <div x-show="currentTab === 'initial'" class="space-y-6">

        <!-- Tab Header -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
            <h3 class="text-lg font-semibold text-blue-900 mb-1">🚀 初回生成プロンプト</h3>
            <p class="text-sm text-blue-700">初めて投稿を生成する際に使用されるプロンプト設定です</p>
        </div>

        <!-- System Prompt: Initial (調査段階) -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <span class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-1 rounded">システム</span>
                        調査段階用プロンプト
                    </h2>
                    <p class="text-sm text-gray-600 mt-2">URLクローリング・thinking実行時に使用（会社情報・役割定義・基本方針）</p>
                </div>
            </div>
            <textarea x-model="prompts.system_prompt_initial"
                      rows="8"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent font-mono text-sm"
                      placeholder="システムプロンプトを入力..."></textarea>
            <div class="mt-4 flex justify-end">
                <button @click="savePrompt('system_prompt_initial')"
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition">
                    💾 保存
                </button>
            </div>
        </div>

        <!-- System Prompt: Final (出力段階) -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <span class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-1 rounded">システム</span>
                        出力段階用プロンプト
                    </h2>
                    <p class="text-sm text-gray-600 mt-2">JSON形式で投稿案を出力する際に使用（投稿例・出力指示）</p>
                </div>
            </div>
            <textarea x-model="prompts.system_prompt_final"
                      rows="6"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent font-mono text-sm"
                      placeholder="システムプロンプトを入力..."></textarea>
            <div class="mt-4 flex justify-end">
                <button @click="savePrompt('system_prompt_final')"
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition">
                    💾 保存
                </button>
            </div>
        </div>

        <!-- User Prompt: Initial -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-1 rounded">ユーザー</span>
                        初回生成用プロンプト
                    </h2>
                    <p class="text-sm text-gray-600 mt-2">投稿情報・コンテキスト・生成手順を指示</p>
                    <p class="text-xs text-gray-500 mt-1">
                        使用可能な変数: <code class="bg-gray-100 px-1 rounded">{date}</code>,
                        <code class="bg-gray-100 px-1 rounded">{decided}</code>,
                        <code class="bg-gray-100 px-1 rounded">{url}</code>,
                        <code class="bg-gray-100 px-1 rounded">{anniversary_line}</code>,
                        <code class="bg-gray-100 px-1 rounded">{remarks}</code>,
                        <code class="bg-gray-100 px-1 rounded">{pinecone_section}</code>,
                        <code class="bg-gray-100 px-1 rounded">{similar_section}</code>
                    </p>
                </div>
            </div>
            <textarea x-model="prompts.user_prompt_template"
                      rows="20"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent font-mono text-sm"
                      placeholder="ユーザープロンプトテンプレートを入力..."></textarea>
            <div class="mt-4 flex justify-end">
                <button @click="savePrompt('user_prompt_template')"
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition">
                    💾 保存
                </button>
            </div>
        </div>
    </div>

    <!-- Refinement Tab -->
    <div x-show="currentTab === 'refinement'" class="space-y-6">

        <!-- Tab Header -->
        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg">
            <h3 class="text-lg font-semibold text-amber-900 mb-1">✨ 改善プロンプト</h3>
            <p class="text-sm text-amber-700">選択された投稿を改善する際に使用されるプロンプト設定です</p>
        </div>

        <!-- System Prompt: Refinement -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <span class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-1 rounded">システム</span>
                        改善用システムプロンプト
                    </h2>
                    <p class="text-sm text-gray-600 mt-2">投稿改善時の役割定義</p>
                </div>
            </div>
            <textarea x-model="prompts.system_prompt_refinement"
                      rows="4"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent font-mono text-sm"
                      placeholder="システムプロンプトを入力..."></textarea>
            <div class="mt-4 flex justify-end">
                <button @click="savePrompt('system_prompt_refinement')"
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition">
                    💾 保存
                </button>
            </div>
        </div>

        <!-- User Prompt: Refinement -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-1 rounded">ユーザー</span>
                        改善用プロンプト
                    </h2>
                    <p class="text-sm text-gray-600 mt-2">元の投稿と改善リクエストを受け取り、改善手順を指示</p>
                    <p class="text-xs text-gray-500 mt-1">
                        使用可能な変数: <code class="bg-gray-100 px-1 rounded">{refinement_instruction}</code>,
                        <code class="bg-gray-100 px-1 rounded">{selected_post}</code>
                    </p>
                </div>
            </div>
            <textarea x-model="prompts.refinement_prompt_template"
                      rows="15"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent font-mono text-sm"
                      placeholder="改善用プロンプトテンプレートを入力..."></textarea>
            <div class="mt-4 flex justify-end">
                <button @click="savePrompt('refinement_prompt_template')"
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition">
                    💾 保存
                </button>
            </div>
        </div>
    </div>

    <!-- Reset Button -->
    <div class="mt-8 flex justify-center">
        <button @click="resetToDefaults()"
                class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium">
            🔄 デフォルトにリセット
        </button>
    </div>

</div>

<!-- Alpine.js Component -->
<script>
function promptSettings() {
    return {
        currentTab: 'initial',
        prompts: {},
        successMessage: '',
        errorMessage: '',

        init() {
            this.loadPrompts();
        },

        async loadPrompts() {
            try {
                const response = await fetch('/api/prompts');
                if (!response.ok) {
                    throw new Error('プロンプトの読み込みに失敗しました');
                }
                this.prompts = await response.json();
            } catch (error) {
                console.error('Error loading prompts:', error);
                this.errorMessage = error.message || 'プロンプトの読み込み中にエラーが発生しました';
            }
        },

        async savePrompt(promptKey) {
            this.successMessage = '';
            this.errorMessage = '';

            try {
                const response = await fetch('/api/prompts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt_key: promptKey,
                        prompt_value: this.prompts[promptKey]
                    })
                });

                if (!response.ok) {
                    throw new Error('プロンプトの保存に失敗しました');
                }

                const data = await response.json();
                this.successMessage = '✅ ' + data.message;

                // Hide success message after 3 seconds
                setTimeout(() => {
                    this.successMessage = '';
                }, 3000);

            } catch (error) {
                console.error('Error saving prompt:', error);
                this.errorMessage = error.message || 'プロンプトの保存中にエラーが発生しました';
            }
        },

        async resetToDefaults() {
            if (!confirm('本当にデフォルト設定にリセットしますか？現在の設定は失われます。')) {
                return;
            }

            this.successMessage = '';
            this.errorMessage = '';

            try {
                const response = await fetch('/api/prompts/reset', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('リセットに失敗しました');
                }

                const data = await response.json();
                this.successMessage = '✅ ' + data.message;

                // Reload prompts
                await this.loadPrompts();

                // Hide success message after 3 seconds
                setTimeout(() => {
                    this.successMessage = '';
                }, 3000);

            } catch (error) {
                console.error('Error resetting prompts:', error);
                this.errorMessage = error.message || 'リセット中にエラーが発生しました';
            }
        }
    };
}
</script>
{% endblock %}
